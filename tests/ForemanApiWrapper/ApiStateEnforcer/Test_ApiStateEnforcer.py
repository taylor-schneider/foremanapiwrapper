from unittest import TestCase
from ForemanApiWrapper.ForemanApiUtilities.ForemanApiWrapper import ForemanApiWrapper
from ForemanApiWrapper.ApiStateEnforcer.ApiStateEnforcer import ApiStateEnforcer
from ForemanApiWrapper.ApiStateEnforcer.RecordModificationReceipt import RecordModificationReceipt

class Test_ApiStateEnforcer(TestCase):

    def __init__(self, *args, **kwargs):
        super(Test_ApiStateEnforcer, self).__init__(*args, **kwargs)
        self.username = "admin"
        self.password = "password"
        self.url = "https://15.4.5.1"
        self.verifySsl = False
        self.api_wrapper = ForemanApiWrapper(self.username, self.password, self.url, self.verifySsl)
        self.api_state_enforcer = ApiStateEnforcer(self.api_wrapper)


    def test_ensure_state_exists_create_record(self):

        record_name = "some_environment"
        record_type = "environment"
        minimal_record = {
            record_type :{
                "name": record_name
            }
        }
        desired_state = "present"

        try:

            with self.assertRaises(Exception) as e:
                 self.api_state_enforcer.ReadRecord(record_type, minimal_record)

            modification_receipt = self.api_state_enforcer.ensure_state(desired_state, minimal_record)

            self.assertIsNotNone(modification_receipt)
            self.assertEqual(type(modification_receipt), RecordModificationReceipt)
            self.assertTrue(modification_receipt.changed)

        finally:
            self.api_state_enforcer.ensure_state("absent", minimal_record)

        def test_ensure_state_noes_not_exist(self):
            record_name = "some_environment"
            record_type = "environment"
            minimal_record = {
                record_type: {
                    "name": record_name
                }
            }
            desired_state = "absent"

            actual_record_state = self.api_state_enforcer.ensure_state(desired_state, minimal_record)

            self.assertIsNotNone(actual_record_state)
            self.assertEqual(type(actual_record_state), dict)

            minimalStateExists = self.api_state_enforcer.ensure_state(desired_state, minimal_record)

            self.assertTrue(minimalStateExists)

    def test_ensure_state_exists_record_exists(self):

        record_name = "some_environment"
        record_type = "environment"
        minimal_record = {
            record_type: {
                "name": record_name
            }
        }
        desired_state = "present"

        try:

            with self.assertRaises(Exception) as e:
                actual_record_state = self.api_state_enforcer.ReadRecord(record_type, minimal_record)

            modification_receipt = self.api_state_enforcer.ensure_state(desired_state, minimal_record)

            modification_receipt = self.api_state_enforcer.ensure_state(desired_state, minimal_record)

            self.assertIsNotNone(modification_receipt)
            self.assertEqual(type(modification_receipt), RecordModificationReceipt)
            self.assertFalse(modification_receipt.changed)

        finally:
            self.api_state_enforcer.ensure_state( "absent", minimal_record)